<html>
	<head>
		<link rel="stylesheet" type="text/css" href="/assets/css/main.css">
		<link href="https://fonts.googleapis.com/css2?family=Recursive&display=swap" rel="stylesheet">
		<script src="/assets/js/main.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.13.0/js/all.min.js"></script>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			var socket = io();
			var selectedUser = 'everyone';
			var savedUsername;
		</script>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
		<title>Real-time chat application using socket.io</title>
	</head>
	<body>
		<div id="header">
			<span id="menu"><i class="fas fa-chevron-down fa-2x" onclick="toggleMenu();"></i></span>
			<h2>Chat Application</h2>
		</div>
		<nav id="nav">
			<span onclick="openUsername();">Change Username</span>
			</br></br>
			<span onclick="openPrivacy();">Privacy Policy</span>
			</br></br>
			<a href="https://github.com/therealsujitk/socketio-chat-app/issues" target="_blank">Open Issue</a>
			</br></br>
			<span onclick="openAbout();">About</span>
		</nav>
		<table id="chat-interface">
			<tr>
				<th id="users-header">Online Users</th>
				<th id="chat-header">@everyone</th>
			</tr>
			<tr>
				<td id="users">
					<div id="user-list" style="height: 60vh; height: var(--cih);overflow-x: hidden; overflow-y: auto;">
						<div id="user-everyone" class="user" style="background: #121212; color: #808080;" onclick="switchInterface(this.id); selectedUser = this.id.slice(5);">@everyone</div>
					</div>
				</td>
				<td id="chat">
					<div id="messages-everyone" class="messages" style="display: block;"></div>
					<div id="chat-footer">
						<input id="chat-box" placeholder="Write your message..." autocomplete="off"></input>
						<input id="send" type="button" value="Send" onclick="send()"></input>
					</div>
				</td>
			</tr>
		</table>
		<div id="menu-background" onclick="toggleMenu();"></div>
		<div id="modal-background" onclick="closeAll();"></div>
		<div id="username-modal" class="modal show-modal">
			<table cellpadding="0" cellspacing="0" style="width: 100%;">
				<td class="header2" style="text-align: left;">Your Details</td>
				<td style="text-align: right;"><i class="header link fas fa-times" onclick="closeAll()"></i></td>
			</table>
			<table cellpadding="0" cellspacing="0" style="width: 100%; padding-top: 20px;">
				<td style="color: #808080;">Username:</td>
				<td><input id="username" class="text-box" type="text" autocomplete="off" spellcheck="false"></input></td>
			</table>
			<input id="save-user" class="btn" type="button" style="margin-top: 10px;" value="Save" onclick="newUser();"></input>
		</div>
		<div id="privacy-modal" class="modal">
			<table cellpadding="0" cellspacing="0" style="width: 100%;">
				<td class="header2" style="text-align: left;">Privacy Policy</td>
				<td style="text-align: right;"><i class="header link fas fa-times" onclick="closeAll()"></i></td>
			</table>
			<p>No data entered here is stored anywhere. All chat history between any two users is completely erased as soon as either user disconnects.</p>
		</div>
		<div id="about-modal" class="modal">
			<table cellpadding="0" cellspacing="0" style="width: 100%;">
				<td class="header2" style="text-align: left;">About</td>
				<td style="text-align: right;"><i class="header link fas fa-times" onclick="closeAll()"></i></td>
			</table>
			<p>Built by: <a style="color: #fff;" href="https://instagram.com/therealsujitk" target="_blank">@therealsujitk</a>.</p>
			<p style="padding-bottom: 10px;">This is an open-source project I built for research purpose. Feel free to fork it on <a style="color: #fff;" href="https://github.com/therealsujitk/socketio-chat-app" target="_blank">GitHub</a>.</p>
			<span id="version">v1.0.0</span>
		</div>
		<script>
			function calcHeight() {
				let headerHeight = document.getElementById('header').offsetHeight;
				let chatInterfaceHeaderHeight = document.getElementById('chat-header').offsetHeight;

				let chatInterfaceHeight = window.innerHeight - headerHeight - chatInterfaceHeaderHeight - 25 - 25 - 6;
				document.documentElement.style.setProperty('--cih', `${chatInterfaceHeight}px`);

				let chatFooterHeight = document.getElementById('chat-footer').offsetHeight;

				let messagesHeight = chatInterfaceHeight - chatFooterHeight - 4;
				document.documentElement.style.setProperty('--mh', `${messagesHeight}px`);
			}

			calcHeight();
			window.addEventListener("resize", calcHeight);

			var i = 0;
			function toggleMenu (){
			    let x = document.getElementById('menu');
			    let y = document.getElementById('nav');
				let z = document.getElementById('menu-background');

			    if(i%2 == 0) {
			        x.classList.add('rotate-menu');
			        y.classList.add('show-nav');
					z.style.display = "block";
			    }
			    else {
			        x.classList.add('rotate-menu-again');
			        y.classList.add('hide-nav');

					setTimeout(function() {
						x.classList.remove('rotate-menu');
						x.classList.remove('rotate-menu-again');
						y.classList.remove('show-nav');
						y.classList.remove('hide-nav');
						z.style.display = "none";
					}, 500);
			    }

				++i;
			}

			function send() {
				if(typeof savedUsername === "undefined") {
					openUsername();
					return;
				}
			
				var message = document.getElementById('chat-box');
				
				if(selectedUser === "everyone") {
					let temp = {};
					temp[savedUsername] = message.value.trim();
					socket.emit('broadcast', temp);
					
					if(message.value.trim() != '') {
						let messages = document.getElementById('messages-everyone');
						messages.innerHTML = messages.innerHTML + '<div style="width: 100%; text-align: right;"><div class="message" style="background: #fff; color: #000;">' + message.value.trim() + '</div></div>';
					}
				}
				else {
					let temp = {};
					temp[selectedUser] = message.value.trim();
					socket.emit('private', temp);
					
					if(message.value.trim() != '') {
						let messages = 'messages-' + selectedUser;
						messages = document.getElementById(messages);
						messages.innerHTML = messages.innerHTML + '<div style="width: 100%; text-align: right;"><div class="message" style="background: #fff; color: #000;">' + message.value.trim() + '</div></div>';
					}
				}

				message.value = '';
			}

			document.getElementById('chat-box').addEventListener("keyup", function(e) {
				if(e.keyCode == 13)
					send();
			});

			socket.on('private', (data) => {
				let id = Object.keys(data)[0];
				let user = 'user-' + id;
				user = document.getElementById(user);
				let messages = 'messages-' + id;
				messages = document.getElementById(messages);
				
				let message = data[id];
				
				messages.innerHTML += '<div style="width: 100%; text-align: left;"><div class="message" style="background: #000; color: #fff;">' + message + '</div></div>';
				if(selectedUser != id)
					user.style.color = "#fff";
			});

			socket.on('broadcast', (data) => {
				let user = Object.keys(data)[0];
				let messages = document.getElementById('messages-everyone');
				let message = data[Object.keys(data)[0]];
				messages.innerHTML += '<div style="width: 100%; text-align: left;"><div class="message" style="background: #000; color: #fff;"><b>' + user + '</b>: ' + message + '</div></div>';
				
				if(selectedUser != "everyone")
					document.getElementById('user-everyone').style.color = "#fff";
			});
			
			function newUser() {
				let username = document.getElementById('username');
				
				if(username.value.trim() == '')
					return;
				else {
					socket.emit('new user', username.value.trim());
					closeAll();
					savedUsername = username.value.trim();
				}
			}
			
			document.getElementById('username').addEventListener("keyup", function(e) {
				if(e.keyCode == 13)
					newUser();
			});
			
			socket.on('new user', (user) => {
				let users = document.getElementById('user-list');
				users.innerHTML += '<div id="user-' + Object.keys(user)[0] + '" class="user" style="background: none; color: #808080;" onclick="switchInterface(this.id); selectedUser = this.id.slice(5);">@' + user[Object.keys(user)[0]] + '</div>';
				let chat = document.getElementById('chat');
				chat.innerHTML = '<div id="messages-' + Object.keys(user)[0] + '" class="messages" style="display: none;"></div>' + chat.innerHTML;
			});
			
			socket.on('online users', (onlineUsers) => {
				let i = 0;
				while(i < Object.keys(onlineUsers).length) {
					let users = document.getElementById('user-list');
					users.innerHTML += '<div id="user-' + Object.keys(onlineUsers)[i] + '" class="user" style="background: none; color: #808080;" onclick="switchInterface(this.id); selectedUser = this.id.slice(5);">@' + onlineUsers[Object.keys(onlineUsers)[i]] + '</div>';
					let chat = document.getElementById('chat');
					chat.innerHTML = '<div id="messages-' + Object.keys(onlineUsers)[i] + '" class="messages" style="display: none;"></div>' + chat.innerHTML;
					++i;
				}
			});
			
			socket.on('delete user', (id) => {
				let user = 'user-' + id;
				user = document.getElementById(user);
				let messages = 'messages-' + id;
				messages = document.getElementById(messages);
				
				user.remove();
				messages.remove();
			});
		</script>
	</body>
</html>
